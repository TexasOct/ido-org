#!/bin/bash
set -e

echo "üîç Running pre-commit code quality checks..."

LINT_RESULT=0
FAILED_FRONTEND=false
FAILED_BACKEND=false
FAILED_FRONTEND_TYPES=false
FAILED_I18N=false
FAILED_LINT_STAGED=false

# Run lint-staged for automatic formatting of staged files
echo "üé® Running lint-staged (auto-formatting staged files)..."
if ! npx lint-staged; then
    LINT_RESULT=$(($LINT_RESULT + 1))
    FAILED_LINT_STAGED=true
fi

# Frontend linting and formatting check
echo "üìù Checking frontend code formatting..."
if ! pnpm lint; then
    LINT_RESULT=$(($LINT_RESULT + 1))
    FAILED_FRONTEND=true
fi

# Frontend TypeScript type checking
echo "‚úÖ Checking frontend TypeScript compilation..."
if ! pnpm tsc; then
    LINT_RESULT=$(($LINT_RESULT + 1))
    FAILED_FRONTEND_TYPES=true
fi

# i18n translation consistency check
echo "üåê Validating i18n translation consistency..."
if ! pnpm check-i18n; then
    LINT_RESULT=$(($LINT_RESULT + 1))
    FAILED_I18N=true
fi

# Backend type checking
echo "üêç Running backend type analysis..."
if ! uv run ty check; then
    LINT_RESULT=$(($LINT_RESULT + 1))
    FAILED_BACKEND=true
fi

# If any checks failed, show detailed error message
if [ $LINT_RESULT -ne 0 ]; then
    echo ""
    echo "\033[0;31m‚ùå Pre-commit checks failed!\033[0m"
    echo "\033[0;33müîß The following checks did not pass:\033[0m"

    if [ "$FAILED_LINT_STAGED" = true ]; then
        echo "   ‚Ä¢ Lint-staged auto-formatting"
    fi

    if [ "$FAILED_FRONTEND" = true ]; then
        echo "   ‚Ä¢ Frontend linting/formatting"
    fi

    if [ "$FAILED_FRONTEND_TYPES" = true ]; then
        echo "   ‚Ä¢ Frontend TypeScript compilation"
    fi

    if [ "$FAILED_I18N" = true ]; then
        echo "   ‚Ä¢ i18n translation consistency"
    fi

    if [ "$FAILED_BACKEND" = true ]; then
        echo "   ‚Ä¢ Backend type checking"
    fi

    echo ""
    echo "\033[0;36müí° To fix these issues:\033[0m"

    if [ "$FAILED_LINT_STAGED" = true ]; then
        echo "\033[0;35müé® Lint-staged Issues:\033[0m"
        echo "1. Check the lint-staged output for formatting errors"
        echo "2. Some files may have prettier formatting issues"
        echo "3. Run '\033[1mpnpm format\033[0m' to fix all files"
        echo ""
    fi

    if [ "$FAILED_FRONTEND" = true ] || [ "$FAILED_FRONTEND_TYPES" = true ]; then
        echo "\033[0;35müé® Frontend Issues:\033[0m"
        if [ "$FAILED_FRONTEND" = true ]; then
            echo "1. Run '\033[1mpnpm format\033[0m' to auto-format TypeScript/JavaScript/CSS"
            echo "2. Review ESLint output for style violations"
        fi
        if [ "$FAILED_FRONTEND_TYPES" = true ]; then
            echo "3. Run '\033[1mpnpm tsc\033[0m' to check TypeScript compilation errors"
            echo "4. Fix all type errors (no @ts-ignore without justification)"
        fi
        echo ""
    fi

    if [ "$FAILED_I18N" = true ]; then
        echo "\033[0;33müåê i18n Issues:\033[0m"
        echo "1. Run '\033[1mpnpm check-i18n\033[0m' to see missing translation keys"
        echo "2. Add missing keys to all locale files (en.ts, zh-CN.ts)"
        echo "3. Ensure all translation keys match across locales"
        echo ""
    fi

    if [ "$FAILED_BACKEND" = true ]; then
        echo "\033[1;36müêç Backend Issues:\033[0m"
        echo "1. Run '\033[1muv run ty check\033[0m' to see detailed type errors"
        echo "2. Add proper type hints (avoid Any types)"
        echo "3. Use protocols for better type safety"
        echo "4. Check for missing imports or incorrect function signatures"
        echo ""
    fi

    echo "\033[0;33müìã General workflow:\033[0m"
    echo "1. Fix all reported issues"
    echo "2. Stage your changes: '\033[1mgit add .\033[0m'"
    echo "3. Commit again: '\033[1mgit commit\033[0m'"
    echo ""
    echo "\033[0;31müí• Commit aborted. Please fix the issues and try again.\033[0m"
    exit 1
fi

echo "\033[0;32m‚úÖ All pre-commit checks passed!\033[0m"
echo "\033[0;36müéâ Ready to commit your changes.\033[0m"
